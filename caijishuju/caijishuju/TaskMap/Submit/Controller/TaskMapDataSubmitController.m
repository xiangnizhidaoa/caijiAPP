//
//  TaskMapDataSubmitController.m
//  caijishuju
//
//  Created by üç≠M on 2020/8/28.
//  Copyright ¬© 2020 ÁâõÊñπË∑Ø. All rights reserved.
//

#import "TaskMapDataSubmitController.h"
#import "MyTaskDetailsThrCell.h"
#import "MyTaskDetailsHeadCell.h"
#import "MyTaskDetailsFouCell.h"
#import "MyTaskDetailsFootCell.h"
#import <AMapLocationKit/AMapLocationKit.h>
#import "MViewToast.h"
#import "MyTaskDetailsFivCell.h"


@interface TaskMapDataSubmitController ()<UITableViewDelegate,UITableViewDataSource,UINavigationControllerDelegate,UIImagePickerControllerDelegate,CLLocationManagerDelegate>

@property (weak, nonatomic) IBOutlet UITableView *tabV;

/** Êï∞ÊçÆ */
@property (nonatomic, strong) NSMutableArray *dataArr;
/** ÂÆö‰Ωç */
@property (nonatomic, strong) AMapLocationManager *locationManager;

/** ÂΩìÂâç‰ΩçÁΩÆ */
@property (nonatomic, assign) CLLocationCoordinate2D nowClCoor2d;

/** Âè∂Â≠êÂõæÁâá */
@property (nonatomic, strong) UIImage *yeziImg;
/** Ê§çÊ†™ÂõæÁâá */
@property (nonatomic, strong) UIImage *zhizhuImg;
/** Âú∞Âùó */
@property (nonatomic, strong) UIImage *dikuaiImg;
/** ÂÆö‰ΩçÁÆ°ÁêÜÂô® */
@property (nonatomic, strong) CLLocationManager *clManager;
/** Âú∞‰ΩçÊùÉÈôêÊèêÁ§∫Ê°Ü */
@property (nonatomic, strong) UIAlertController *clAc;

/** ÂõæÁâá‰∏ãË°® */
@property (nonatomic, assign) NSInteger imgSelect;
/*** ÁúÅ ***/
@property (nonatomic, copy) NSString *provinceStr;
/*** Â∏Ç ***/
@property (nonatomic, copy) NSString *cityStr;
/*** Âå∫ ***/
@property (nonatomic, copy) NSString *districtStr;



@end

@implementation TaskMapDataSubmitController

- (NSMutableArray *)dataArr {
    if (!_dataArr) {
        self.dataArr = [@[
            @{
                @"type":@"1",
                @"title":@"",
                @"text":@""
            },
            [@{
                @"type":@"2",
                @"title":@"‰ΩúÁâ©ÂêçÁß∞",
                @"count":[NSNumber numberWithInteger:200],
                @"holder":@"‰ΩúÁâ©ÂêçÁß∞(Ëá™Âä®ËØÜÂà´)",
                @"text":@""
            } mutableCopy],
            @{
                @"type":@"3",
                @"title":@"Âè∂Â≠êÁÖßÁâá",
                @"text":@""
            },
            @{
                @"type":@"3",
                @"title":@"Ê§çÊ†™ÁÖßÁâá",
                @"text":@""
            },
            @{
                @"type":@"3",
                @"title":@"Âú∞ÂùóÁÖßÁâá",
                @"text":@""
            },
            [@{
                @"type":@"5",
                @"title":@"Â§áÊ≥®",
                @"count":[NSNumber numberWithInteger:200],
                @"holder":@"Â§áÊ≥®(200Â≠ó)",
                @"text":@""
            } mutableCopy],
            @{
                @"type":@"4",
                @"title":@"",
                @"text":@""
            },
        ] mutableCopy];
    }
    return _dataArr;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationItem.title = @"Êï∞ÊçÆÂ°´Êä•";
    
    if (@available(iOS 11.0, *)) {
        self.tabV.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
        self.tabV.contentInset = UIEdgeInsetsMake(0, 0, 0, 0);
        self.tabV.scrollIndicatorInsets = self.tabV.contentInset;
    }else {
        self.automaticallyAdjustsScrollViewInsets = NO;
    }
    self.tabV.rowHeight = UITableViewAutomaticDimension;
    self.tabV.estimatedRowHeight = 30;

    [self.tabV registerNib:[UINib nibWithNibName:@"MyTaskDetailsThrCell" bundle:[NSBundle mainBundle]] forCellReuseIdentifier:@"MyTaskDetailsThrCell"];
    [self.tabV registerNib:[UINib nibWithNibName:@"MyTaskDetailsHeadCell" bundle:[NSBundle mainBundle]] forCellReuseIdentifier:@"MyTaskDetailsHeadCell"];
    [self.tabV registerNib:[UINib nibWithNibName:@"MyTaskDetailsFouCell" bundle:[NSBundle mainBundle]] forCellReuseIdentifier:@"MyTaskDetailsFouCell"];
    [self.tabV registerNib:[UINib nibWithNibName:@"MyTaskDetailsFootCell" bundle:[NSBundle mainBundle]] forCellReuseIdentifier:@"MyTaskDetailsFootCell"];
    [self.tabV registerNib:[UINib nibWithNibName:@"MyTaskDetailsFivCell" bundle:[NSBundle mainBundle]] forCellReuseIdentifier:@"MyTaskDetailsFivCell"];
    
    [self HPSILocationJurisdiction];
    
    
}

/** ‰øùÂ≠ò */
- (IBAction)TMDSSaveBtAction:(UIButton *)sender {
    [self.view endEditing:YES];
    if ([self TMDSVerifyBody]) {
        [self TMDSSubmitRequest];
    }
}

/** ÈááÈõÜÂú∞Âõæ */
- (IBAction)TMDSMapBtAction:(UIButton *)sender {
    [self.navigationController popViewControllerAnimated:YES];
}


#pragma mark ---- UItableView
/**
 ÂàÜÂå∫
 */
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return 1;
}


/**
 Ë°åÊï∞
 */
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.dataArr.count;
}

/**
 Â§¥ÈÉ®È´òÂ∫¶
 */
- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section {
    return 0.01;
}

/**
 Â∞æÈÉ®È´òÂ∫¶
 */
- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section {
    return 0.01;
}



/**
 cellËµãÂÄº
 */
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSString *typeStr = [[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"type"];
    NSString *titleStr = [[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"title"];
    NSString *detailStr = [[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"text"];
    
    if ([typeStr isEqualToString:@"1"]) {
        MyTaskDetailsHeadCell *cellOne = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsHeadCell" forIndexPath:indexPath];
        return cellOne;
        
        
    } else if ([typeStr isEqualToString:@"2"]) {
        if (self.type == 0) {
            MyTaskDetailsFouCell *cellTwo = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsFouCell" forIndexPath:indexPath];
            cellTwo.wordCount = [[[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"count"] integerValue];
            cellTwo.detailsTf.placeholder = [[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"holder"];
            cellTwo.titleLb.text = titleStr;
            cellTwo.finishBlock = ^(NSString * _Nonnull text) {
                [[self.dataArr objectAtIndex:indexPath.row] setObject:[self isNoBlankText:text] forKey:@"text"];
            };
            return cellTwo;
        }else{
            MyTaskDetailsFouCell *cellTwo = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsFouCell" forIndexPath:indexPath];
            cellTwo.wordCount = [[[self.dataArr objectAtIndex:indexPath.row] objectForKey:@"count"] integerValue];
            cellTwo.titleLb.text = titleStr;
            cellTwo.detailsTf.text = self.model.zuowumc;
            cellTwo.detailsTf.userInteractionEnabled = NO;
            return cellTwo;
        }
    } else if ([typeStr isEqualToString:@"3"]) {
        if (self.type == 0) {
            MyTaskDetailsThrCell *cellThr = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsThrCell" forIndexPath:indexPath];
            cellThr.titleLb.text = titleStr;
            cellThr.selectBlock = ^{
                self.imgSelect = indexPath.row;
                [self HPSICameraJurisdiction];
                
            };
            
            if (indexPath.row==2) {
                cellThr.detailsIv.image = self.yeziImg;
            } else if (indexPath.row==3) {
                cellThr.detailsIv.image = self.zhizhuImg;
            } else if (indexPath.row==4) {
                cellThr.detailsIv.image = self.dikuaiImg;
            }
            
            return cellThr;
        }else{
            MyTaskDetailsThrCell *cellThr = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsThrCell" forIndexPath:indexPath];
            cellThr.titleLb.text = titleStr;
            if (indexPath.row == 2) {
                [cellThr.detailsIv sd_setImageWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@?type=s&id=%@",BS_Url.downImage,self.model.yepianzpid]] placeholderImage:[UIImage imageNamed:@"upload"]];
            }else if (indexPath.row == 3){
                [cellThr.detailsIv sd_setImageWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@?type=s&id=%@",BS_Url.downImage,self.model.zhizhuzpid]] placeholderImage:[UIImage imageNamed:@"upload"]];
            }else if (indexPath.row == 4){
                [cellThr.detailsIv sd_setImageWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@?type=s&id=%@",BS_Url.downImage,self.model.dikuaizpid]] placeholderImage:[UIImage imageNamed:@"upload"]];
            }
            cellThr.detailsIv.userInteractionEnabled = NO;
            return cellThr;
        }
   } else if ([typeStr isEqualToString:@"4"]) {
      MyTaskDetailsFootCell *cellFou = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsFootCell" forIndexPath:indexPath];
       return cellFou;
   } else if ([typeStr isEqualToString:@"5"]) {
       if (self.type == 0) {
           MyTaskDetailsFivCell *cellFiv = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsFivCell" forIndexPath:indexPath];
           cellFiv.finishBlock = ^(NSString * _Nonnull text) {
               [[self.dataArr objectAtIndex:indexPath.row] setObject:[self isNoBlankText:text] forKey:@"text"];
           };
           
           return cellFiv;
       }else{
           MyTaskDetailsFivCell *cellFiv = [self.tabV dequeueReusableCellWithIdentifier:@"MyTaskDetailsFivCell" forIndexPath:indexPath];
           cellFiv.detailTv.text = self.model.remarks;
           cellFiv.hintLb.hidden = YES;
           cellFiv.detailTv.userInteractionEnabled = NO;
           
           return cellFiv;
       }
       
   }
    return nil;
}

/**
 ÁÇπÂáªcell
 */
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    
}

/**
 Âà§Êñ≠ÈùûÁ©∫
 */
- (BOOL)isBlankString:(NSString *)aStr {
    if (!aStr) {
        return YES;
    }
    if ([aStr isKindOfClass:[NSNull class]]) {
        return YES;
    }
    if (!aStr.length) {
        return YES;
    }
    NSCharacterSet *set = [NSCharacterSet whitespaceAndNewlineCharacterSet];
    NSString *trimmedStr = [aStr stringByTrimmingCharactersInSet:set];
    if (!trimmedStr.length) {
        return YES;
    }
    return NO;
}

/**
 Âà§Êñ≠Â≠óÁ¨¶‰∏≤ÊòØÂê¶‰∏∫Á©∫,Á©∫ËøîÂõû@""

 @return Á©∫ @""  ‰∏ç‰∏∫Á©∫ text
 */
- (NSString *)isNoBlankText:(NSString *)text {
    if ([self isBlankString:text]) {
        return @"";
    }
    return text;
}

#pragma mark - ÂÆö‰Ωç

/**
 ÂÆö‰ΩçÊùÉÈôê
 */
- (void)HPSILocationJurisdiction {
    self.clManager = [[CLLocationManager alloc] init];
    [self.clManager requestAlwaysAuthorization];//‰∏ÄÁõ¥Ëé∑ÂèñÂÆö‰Ωç‰ø°ÊÅØ
    [self.clManager requestWhenInUseAuthorization];//‰ΩøÁî®ÁöÑÊó∂ÂÄôËé∑ÂèñÂÆö‰Ωç‰ø°ÊÅØ
    self.clManager.delegate = self;
    if ([CLLocationManager locationServicesEnabled]) {
        CLAuthorizationStatus locationStatus = [CLLocationManager authorizationStatus];
        if (locationStatus==kCLAuthorizationStatusNotDetermined) {
            /** Ê≤°ÊúâÈÄâÊã© */
            MLog(@"Ê≤°ÊúâÈÄâÊã©");
            
        } else if ((locationStatus==kCLAuthorizationStatusRestricted)||(locationStatus==kCLAuthorizationStatusDenied)) {
            /** ÈôêÂà∂&ÊãíÁªù */
            MLog(@"ÊãíÁªù");
            self.clAc = [UIAlertController alertControllerWithTitle:@"ËØ∑ÂÖÅËÆ∏ÂÆö‰ΩçÊúçÂä°" message:@"ÂéªÊâãÊú∫Á≥ªÁªü\"ËÆæÁΩÆ-ÈöêÁßÅ-ÂÆö‰ΩçÊúçÂä°\"ÂºÄÂêØ‰∏Ä‰∏ãÂêß" preferredStyle:UIAlertControllerStyleAlert];
            [self.clAc addAction:[UIAlertAction actionWithTitle:@"Áü•ÈÅì‰∫Ü" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
                [self.navigationController popViewControllerAnimated:YES];
            }]];
            [self presentViewController:self.clAc animated:YES completion:nil];
            
        } else if ((locationStatus==kCLAuthorizationStatusAuthorizedAlways)||(locationStatus==kCLAuthorizationStatusAuthorizedWhenInUse)) {
            /** ÂßãÁªàÂÖÅËÆ∏&‰ªÖÂú®‰ΩøÁî®ÊúüÈó¥ */
            MLog(@"ÊéàÊùÉ");
            [self isHomeGetMyLocation];
        }
    } else {
        [MViewToast MShowWithText:@"ÊöÇ‰∏çÊîØÊåÅÂÆö‰Ωç"];
        
    }
    
    
}

- (void)locationManager:(CLLocationManager *)manager didChangeAuthorizationStatus:(CLAuthorizationStatus)status {
    if (status==kCLAuthorizationStatusNotDetermined) {
        /** Ê≤°ÊúâÈÄâÊã© */
        MLog(@"======Ê≤°ÊúâÈÄâÊã©");
        
    } else if ((status==kCLAuthorizationStatusRestricted)||(status==kCLAuthorizationStatusDenied)) {
        /** ÈôêÂà∂&ÊãíÁªù */
        MLog(@"========ÊãíÁªù");
        self.clAc = [UIAlertController alertControllerWithTitle:@"ËØ∑ÂÖÅËÆ∏ÂÆö‰ΩçÊúçÂä°" message:@"ÂéªÊâãÊú∫Á≥ªÁªü\"ËÆæÁΩÆ-ÈöêÁßÅ-ÂÆö‰ΩçÊúçÂä°\"ÂºÄÂêØ‰∏Ä‰∏ãÂêß" preferredStyle:UIAlertControllerStyleAlert];
        [self.clAc addAction:[UIAlertAction actionWithTitle:@"Áü•ÈÅì‰∫Ü" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
            [self.navigationController popViewControllerAnimated:YES];
        }]];
        [self presentViewController:self.clAc animated:YES completion:nil];
    } else if ((status==kCLAuthorizationStatusAuthorizedAlways)||(status==kCLAuthorizationStatusAuthorizedWhenInUse)) {
        /** ÂßãÁªàÂÖÅËÆ∏&‰ªÖÂú®‰ΩøÁî®ÊúüÈó¥ */
        MLog(@"=========ÊéàÊùÉ");
        [self isHomeGetMyLocation];
    }
    
}


/**
 Ëé∑ÂèñÂÆö‰Ωç
 */
- (void)isHomeGetMyLocation {
    self.locationManager = [[AMapLocationManager alloc] init];
    // Â∏¶ÈÄÜÂú∞ÁêÜ‰ø°ÊÅØÁöÑ‰∏ÄÊ¨°ÂÆö‰ΩçÔºàËøîÂõûÂùêÊ†áÂíåÂú∞ÂùÄ‰ø°ÊÅØÔºâ
    [self.locationManager setDesiredAccuracy:kCLLocationAccuracyHundredMeters];
    //   ÂÆö‰ΩçË∂ÖÊó∂Êó∂Èó¥ÔºåÊúÄ‰Ωé2sÔºåÊ≠§Â§ÑËÆæÁΩÆ‰∏∫2s
    self.locationManager.locationTimeout =5;
    //   ÈÄÜÂú∞ÁêÜËØ∑Ê±ÇË∂ÖÊó∂Êó∂Èó¥ÔºåÊúÄ‰Ωé2sÔºåÊ≠§Â§ÑËÆæÁΩÆ‰∏∫2s
    self.locationManager.reGeocodeTimeout =5;
    [self.locationManager requestLocationWithReGeocode:YES completionBlock:^(CLLocation *location, AMapLocationReGeocode *regeocode, NSError *error) {
        
        if (error) {
            MLog(@"ÂÆö‰ΩçÂºÇÂ∏∏\nlocError:{%ld - %@};", (long)error.code, error.localizedDescription);
            
            if (error.code == AMapLocationErrorLocateFailed) {
                return;
            }
        }
        
        MLog(@"location:%@\n%f,%f", location,location.coordinate.longitude,location.coordinate.latitude);
        /** ÁªèÁ∫¨Â∫¶ */
        CLLocationCoordinate2D gcj02Coord = CLLocationCoordinate2DMake(location.coordinate.latitude, location.coordinate.longitude);
        self.nowClCoor2d = gcj02Coord;
        if (regeocode) {
            MLog(@"reGeocode:%@", regeocode);
            self.provinceStr = regeocode.province;
            self.cityStr = regeocode.city;
            self.districtStr = regeocode.district;
        }
        
        
    }];
}

/**
 Áõ∏Êú∫ÊùÉÈôê
 */
- (void)HPSICameraJurisdiction {
    
    if ([UIImagePickerController isSourceTypeAvailable: UIImagePickerControllerSourceTypeCamera]){
        
        AVAuthorizationStatus authstatus = [AVCaptureDevice authorizationStatusForMediaType:AVMediaTypeVideo];
        if (authstatus == AVAuthorizationStatusNotDetermined) {
            /** Êú™Á°ÆÂÆö */
            [AVCaptureDevice requestAccessForMediaType:AVMediaTypeVideo completionHandler:^(BOOL granted) {//Áõ∏Êú∫ÊùÉÈôê
                dispatch_async(dispatch_get_main_queue(), ^{
                    if (granted) {
                        MLog(@"Áõ∏Êú∫ÊéàÊùÉ");
                            /** ÊãçÁÖß */
                        [self HPSICreateCamera];
                        
                    }else{

                        [MViewToast MShowWithText:@"Êú™ÂºÄÂêØÁõ∏Êú∫ÊùÉÈôê,Êó†Ê≥ïÊèê‰æõÊãçÁÖßÂäüËÉΩ"];
                        
                    }
                });
              
            }];
            
        } else if (authstatus == AVAuthorizationStatusDenied || authstatus == AVAuthorizationStatusRestricted) {
            /** ÊãíÁªù */
            UIAlertController *cameraAc = [UIAlertController alertControllerWithTitle:@"ËØ∑ÂÖÅËÆ∏ËÆøÈóÆÁõ∏Êú∫" message:@"ÂéªÊâãÊú∫Á≥ªÁªü\"ËÆæÁΩÆ-ÈöêÁßÅ-Áõ∏Êú∫\"ÂºÄÂêØ‰∏Ä‰∏ãÂêß" preferredStyle:UIAlertControllerStyleAlert];
            [cameraAc addAction:[UIAlertAction actionWithTitle:@"Áü•ÈÅì‰∫Ü" style:UIAlertActionStyleCancel handler:nil]];
            [self presentViewController:cameraAc animated:YES completion:nil];
        } else if (authstatus == AVAuthorizationStatusAuthorized) {
            /** ÊéàÊùÉ */
                /** ÊãçÁÖß */
            [self HPSICreateCamera];
            
            
        }
        
    } else {
        
        UIAlertController *cameraAc = [UIAlertController alertControllerWithTitle:@"ÂΩìÂâçËÆæÂ§á‰∏çÊîØÊåÅÁõ∏Êú∫" message:nil preferredStyle:UIAlertControllerStyleAlert];
        [cameraAc addAction:[UIAlertAction actionWithTitle:@"Áü•ÈÅì‰∫Ü" style:UIAlertActionStyleCancel handler:nil]];
        [self presentViewController:cameraAc animated:YES completion:nil];
    }
    
}

/**
 ÊãçÁÖß
 */
- (void)HPSICreateCamera {
    UIImagePickerController * picker = [[UIImagePickerController alloc] init];
    picker.delegate = self;
//    picker.allowsEditing = YES;
    picker.sourceType = UIImagePickerControllerSourceTypeCamera;
//    [picker.navigationBar setBarTintColor:[UIColor colorWithRed:228/255.0 green:228/255.0 blue:228/255.0 alpha:1]];
//    [picker.navigationBar setTranslucent:NO];
//    picker.navigationBar.tintColor = [UIColor whiteColor];
//    [picker.navigationBar setTitleTextAttributes: [NSDictionary dictionaryWithObjectsAndKeys:[UIColor whiteColor], NSForegroundColorAttributeName, [UIFont boldSystemFontOfSize:17], NSFontAttributeName, nil]];
    [self presentViewController:picker animated:YES completion:nil];
}

/**
 ÁºñËæëÊàêÂäü‰πãÂêé
 */
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<UIImagePickerControllerInfoKey, id> *)info {
//    // Ëé∑ÂèñÂéüÂßãÂõæÁâá
    UIImage * originalImage = [info objectForKey:UIImagePickerControllerOriginalImage];
//    // Ëé∑ÂèñÁºñËæëÂõæÁâá
//    UIImage * editImage = [info objectForKey:UIImagePickerControllerEditedImage];
//
//    NSData *imgData = UIImageJPEGRepresentation(editImage, 0.2f);
//    [self HPSISaveImageToPhotoAlbum:editImage];
//    self.signInIv.image = editImage;
//
//    self.siModel.imgData = imgData;
    if (self.imgSelect==2) {
        self.yeziImg = originalImage;
        NSData *imgData = UIImageJPEGRepresentation(originalImage, 0.2f);
        NSDictionary *dic = @{@"code_id":@"4355549-d04f-40e0-afb7-bbb1faf",@"column":@"yepian",@"isreplace":@"1",@"filePath":imgData};
        [self loadImageWithDic:dic];
        
    } else if (self.imgSelect==3) {
        self.zhizhuImg = originalImage;
        NSData *imgData = UIImageJPEGRepresentation(originalImage, 0.2f);
        NSDictionary *dic = @{@"code_id":@"4355549-d04f-40e0-afb7-bbb1faf",@"column":@"zhizhu",@"isreplace":@"1",@"filePath":imgData};
        [self loadImageWithDic:dic];
    } else if (self.imgSelect==4) {
        self.dikuaiImg = originalImage;
        NSData *imgData = UIImageJPEGRepresentation(originalImage, 0.2f);
        NSDictionary *dic = @{@"code_id":@"4355549-d04f-40e0-afb7-bbb1faf",@"column":@"dikuai",@"isreplace":@"1",@"filePath":imgData};
        [self loadImageWithDic:dic];
    }
    [self.tabV reloadData];
    // Â∞ÜÊ®°ÊÄÅÊòæÁ§∫ÁöÑËßÜÂõæÊéßÂà∂Âô®Ê∂àÂ§±
    [picker dismissViewControllerAnimated:YES completion:nil];
    
    
}

//‰∏ä‰º†ÂõæÁâá
-(void)loadImageWithDic:(NSDictionary *)dic{
    [LSNetworkService postUpLoadImageWithDic:dic response:^(id dict, BSError *error) {
        if (dict != nil) {
            NSDictionary *dicc = [NSJSONSerialization JSONObjectWithData:dict options:NSJSONReadingMutableLeaves error:nil];
            NSLog(@"%@",dicc);
            if (dicc != nil) {
                if ([dic[@"column"] isEqualToString:@"yepian"]) {
                    [LSNetworkService getZhiwuImageWithDic:@{@"fileid":dicc[@"id"]} response:^(id dict, BSError *error) {
                        if (dict != nil) {
                            NSDictionary *dic1 = [NSJSONSerialization JSONObjectWithData:dict options:NSJSONReadingMutableLeaves error:nil];
                            NSLog(@"%@",dic1);
                            if ([dic1[@"status"] integerValue] == 1) {
                                
                            }else{
                                [LPUnitily showToastWithText:dic1[@"message"]];
                            }
                        }
                    }];
                }
            }else{
                [LPUnitily showToastWithText:dicc[@"message"]];
            }
        }
    }];
}


/**
 ÂèñÊ∂àÊãçÁÖß
 */
- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    [picker dismissViewControllerAnimated:YES completion:nil];
}


/// Ê†°È™åÊèê‰∫§ÂèÇÊï∞
- (BOOL)TMDSVerifyBody {
    if ([[[self.dataArr objectAtIndex:1] objectForKey:@"text"] length]==0) {
        [MViewToast MShowWithText:@"ËØ∑Â°´ÂÜô‰ΩúÁâ©ÂêçÁß∞"];
        return NO;
    }
    if (self.yeziImg==nil) {
        [MViewToast MShowWithText:@"ËØ∑Ê∑ªÂä†Âè∂Â≠êÁÖßÁâá"];
        return NO;
    }
    if (self.zhizhuImg==nil) {
        [MViewToast MShowWithText:@"ËØ∑Ê∑ªÂä†Ê§çÊ†™ÁÖßÁâá"];
        return NO;
    }
    if (self.dikuaiImg==nil) {
        [MViewToast MShowWithText:@"ËØ∑Ê∑ªÂä†Âú∞ÂùóÁÖßÁâá"];
        return NO;
    }
    return YES;
}


/// ‰øùÂ≠ò
- (void)TMDSSubmitRequest {
    
    NSString *bodyStr = [NSString stringWithFormat:@"%@?zuowumc=%@Ùè±ªÙè±ªÙè∞ßÙè∞ßÙè±≠Ùè±≠&remarks=%@&id=f774f06d434d4e549da35de897196559&fi lecode=a8894ed2-48a4-d549-8680-9ca6fba5bba0&weidu1=&jingdu1=& weidu=0&jingdu=0&weidu2=%f&jingdu2=%f&province=%@&city=%@&distric t=%@&renwuid=&chaoxiang=146&jingduzhi=high&zhuangtai=5",BS_Url.dataSave,[[self.dataArr objectAtIndex:1] objectForKey:@"text"],[[self.dataArr objectAtIndex:5] objectForKey:@"text"],self.nowClCoor2d.latitude,self.nowClCoor2d.longitude,self.provinceStr,self.cityStr,self.districtStr   ];
    
    [LSNetworkService getDataCollectionSaveWithString:bodyStr response:^(id dict, BSError *error) {
        if (dict != nil) {
            NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:dict options:NSJSONReadingMutableLeaves error:nil];
            NSLog(@"%@",dic);
            if ([dic[@"status"] integerValue] == 1) {
                
                UIAlertController *cameraAc = [UIAlertController alertControllerWithTitle:nil message:@"‰øùÂ≠òÊàêÂäü" preferredStyle:UIAlertControllerStyleAlert];
                [cameraAc addAction:[UIAlertAction actionWithTitle:@"Áü•ÈÅì‰∫Ü" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
                    [self.navigationController popViewControllerAnimated:YES];
                }]];
                [self presentViewController:cameraAc animated:YES completion:nil];
                
            }else{
                [LPUnitily showToastWithText:dic[@"message"]];
            }
        }
    }];
    
}



@end
